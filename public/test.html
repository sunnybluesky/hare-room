<!DOCTYPE html>
<html>

<body>
  <h1>Google Sheets API (OAuth2) 連携 1</h1>
  <button id="auth_btn" onclick="handleAuthClick()">ログインしてデータ取得</button>
  <pre id="content" style="white-space: pre-wrap;"></pre>
  <p id="output"></p>
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client"></script>

  <script>
    // --- 設定エリア ---
const CLIENT_ID = '495789808318-eobf2v7itf2g261oc1m7si75unijthmk.apps.googleusercontent.com';
const API_KEY = 'AIzaSyCYfUOA5obSJymkLhf4x3_nkKWWEofjnIY'; // ★追加: Google Cloud Consoleで発行したAPIキー
const SPREADSHEET_ID = '1lqzR6OCwLsKah7sTxkc5eE4CdVTa_wDNce4no3rfs34';
const RANGE = 'シート1!B1';
const SCOPES = 'https://www.googleapis.com/auth/spreadsheets.readonly';

// 1. GAPI（APIクライアント）の初期化
function gapiLoaded() {
  gapi.load('client', async () => {
    await gapi.client.init({
      apiKey: API_KEY, // ★重要: APIキーをセット
      discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"],
    });
    gapiInited = true;
  });
}

// 2. GIS（認証用ライブラリ）の初期化
function gisLoaded() {
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID, // ★修正: 'YOUR_CLIENT_ID' から変数名に変更
    scope: SCOPES,
    callback: (tokenResponse) => {
      if (tokenResponse.error !== undefined) {
        console.error("認証エラー:", tokenResponse);
        return;
      }
      gapi.client.setToken(tokenResponse);
      console.log("認証成功！");
      listMajors();
    },
  });
  gisInited = true;
}
    // 3. ログインボタン押下時
    function handleAuthClick() {
      // すでに有効なトークンがあるか確認、なければポップアップを表示
      if (gapi.client.getToken() === null) {
        tokenClient.requestAccessToken({ prompt: 'consent' });
      } else {
        tokenClient.requestAccessToken({ prompt: '' });
      }
    }

    // 4. 実際にデータを取得する処理
    async function listMajors() {
      try {
        const response = await gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: SPREADSHEET_ID,
          range: RANGE,
        });
        const value = response.result.values[0][0];
        document.getElementById('content').innerText = "取得した値: " + value;
      } catch (err) {
        document.getElementById('content').innerText = err.message;
      }
    }
async function initClient() {
      try {
        // 2. APIキーとDiscovery Docsで初期化
        await gapi.client.init({
          apiKey: API_KEY,
          discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"],
        });

        // 3. データの取得（ログイン処理なしで直接呼べる）
        const response = await gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: SPREADSHEET_ID,
          range: RANGE,
        });

        console.log(response.result.values);
      } catch (err) {
        document.getElementById('output').innerText = "エラー: " + err.message;
      }
    }
    // ライブラリの読み込み
    window.onload = () => {
      gapiLoaded();
      gisLoaded();
      gapi.load('client', initClient);
    };
    
  </script>
</body>

</html>