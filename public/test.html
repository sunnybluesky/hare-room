<!DOCTYPE html>
<html>
<body>
  <h1>Google Sheets API (OAuth2) 連携</h1>
  <button id="auth_btn" onclick="handleAuthClick()">ログインしてデータ取得</button>
  <pre id="content" style="white-space: pre-wrap;"></pre>

  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client"></script>

  <script>
    const CLIENT_ID = '495789808318-eobf2v7itf2g261oc1m7si75unijthmk.apps.googleusercontent.com'; // 取得したID
    const SCOPES = 'https://www.googleapis.com/auth/spreadsheets.readonly';
    const SPREADSHEET_ID = '1lqzR6OCwLsKah7sTxkc5eE4CdVTa_wDNce4no3rfs34'; // 操作したいシートID
    const RANGE = 'シート1!A1'; // 取得したい範囲

    let tokenClient;
    let gapiInited = false;
    let gisInited = false;

    // 1. GAPI（APIクライアント）の初期化
    function gapiLoaded() {
      gapi.load('client', async () => {
        await gapi.client.init({
          // ここでAPIキーは不要（トークンを使うため）
          discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"],
        });
        gapiInited = true;
      });
    }

    // 2. GIS（認証用ライブラリ）の初期化
    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: (resp) => {
          if (resp.error !== undefined) throw (resp);
          listMajors(); // 認証成功後に実行
        },
      });
      gisInited = true;
    }

    // 3. ログインボタン押下時
    function handleAuthClick() {
      // すでに有効なトークンがあるか確認、なければポップアップを表示
      if (gapi.client.getToken() === null) {
        tokenClient.requestAccessToken({prompt: 'consent'});
      } else {
        tokenClient.requestAccessToken({prompt: ''});
      }
    }

    // 4. 実際にデータを取得する処理
    async function listMajors() {
      try {
        const response = await gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: SPREADSHEET_ID,
          range: RANGE,
        });
        const value = response.result.values[0][0];
        document.getElementById('content').innerText = "取得した値: " + value;
      } catch (err) {
        document.getElementById('content').innerText = err.message;
      }
    }

    // ライブラリの読み込み
    window.onload = () => {
      gapiLoaded();
      gisLoaded();
    };
  </script>
</body>
</html>